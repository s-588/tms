package tables

import (
	"fmt"
	"github.com/s-588/tms/models"
	. "github.com/s-588/tms/static/template/components"
	"time"
)

templ FuelsTable(fuels []models.Fuel, limit, offset, totalCount int, filter models.FuelFilter) {
	<div class="box">
		<!-- Operations Bar -->
		<div class="level mb-5">
			<div class="level-left">
				<div class="level-item">
					<button
						class="button is-primary"
						hx-get="/fuels/new"
						hx-target="#modal-container"
						hx-push-url="true"
					>
						<span class="icon"><i class="fas fa-plus"></i></span>
						<span>New Fuel Type</span>
					</button>
				</div>
				<div class="level-item">
					<button
						class="button is-danger"
						id="delete-selected"
						hx-delete="/fuels"
						hx-include="[name='selected_ids']:checked"
						hx-target="#fuels-table"
						hx-confirm="Are you sure you want to delete selected fuel types?"
					>
						<span class="icon"><i class="fas fa-trash"></i></span>
						<span>Delete Selected</span>
					</button>
				</div>
				<div class="level-item">
					<button
						class="button is-info"
						hx-get={ "/fuels/export?" + filter.ToQueryString() }
						hx-target="_blank"
					>
						<span class="icon"><i class="fas fa-download"></i></span>
						<span>Export</span>
					</button>
				</div>
			</div>
		</div>
		<!-- Filter Bar -->
		<div class="box mb-5">
			<form id="fuel-filter-form" hx-get="/fuels" hx-target="#fuels-table" hx-push-url="true">
				<div class="field is-horizontal">
					<div class="field-body">
						<div class="field">
							<label class="label is-small">Name</label>
							<div class="control">
								<input class="input is-small" type="text" name="name" placeholder="Search fuel name" value={ filter.Name.Value }/>
							</div>
						</div>
						<div class="field">
							<label class="label is-small">Supplier</label>
							<div class="control">
								<input class="input is-small" type="text" name="supplier" placeholder="Search supplier" value={ filter.Supplier.Value }/>
							</div>
						</div>
						<div class="field">
							<label class="label is-small">Price Min</label>
							<div class="control">
								<input class="input is-small" type="number" step="0.01" name="price_min" placeholder="Min price" value={ filter.PriceMin.Value }/>
							</div>
						</div>
						<div class="field">
							<label class="label is-small">Price Max</label>
							<div class="control">
								<input class="input is-small" type="number" step="0.01" name="price_max" placeholder="Max price" value={ filter.PriceMax.Value }/>
							</div>
						</div>
					</div>
				</div>
				<div class="field is-horizontal mt-3">
					<div class="field-body">
						<div class="field">
							<label class="label is-small">Created From</label>
							<div class="control">
								<input class="input is-small" type="date" name="created_from" value={ filter.CreatedFrom.Value.Format(time.DateTime) }/>
							</div>
						</div>
						<div class="field">
							<label class="label is-small">Created To</label>
							<div class="control">
								<input class="input is-small" type="date" name="created_to" value={ filter.CreatedTo.Value.Format(time.DateTime) }/>
							</div>
						</div>
						<div class="field">
							<label class="label is-small">Updated From</label>
							<div class="control">
								<input class="input is-small" type="date" name="updated_from" value={ filter.UpdatedFrom.Value.Format(time.DateTime) }/>
							</div>
						</div>
						<div class="field">
							<label class="label is-small">Updated To</label>
							<div class="control">
								<input class="input is-small" type="date" name="updated_to" value={ filter.UpdatedTo.Value.Format(time.DateTime) }/>
							</div>
						</div>
					</div>
				</div>
				<div class="field is-horizontal mt-3">
					<div class="field-body">
						<div class="field">
							<div class="control">
								<button class="button is-primary is-small" type="submit">
									<span class="icon"><i class="fas fa-filter"></i></span>
									<span>Apply Filters</span>
								</button>
								<button
									class="button is-light is-small"
									type="button"
									hx-get="/fuels"
									hx-target="#fuels-table"
									hx-push-url="true"
								>
									Clear Filters
								</button>
							</div>
						</div>
					</div>
				</div>
			</form>
		</div>
		<!-- Table -->
		<div class="table-container">
			<table class="table is-fullwidth is-striped is-hoverable">
				<thead>
					<tr>
						<th><input type="checkbox" id="select-all-fuels" onchange="toggleAllCheckboxes(this, 'fuel-checkbox')"/></th>
						<th>
							<a href={ "/fuels?sort=fuel_id&order=" + GetSortOrder("fuel_id", filter.SortBy.Value, filter.SortOrder.Value) }>
								ID { GetSortIcon("fuel_id", filter.SortBy.Value, filter.SortOrder.Value) }
							</a>
						</th>
						<th>
							<a href={ "/fuels?sort=name&order=" + GetSortOrder("name", filter.SortBy.Value, filter.SortOrder.Value) }>
								Name { GetSortIcon("name", filter.SortBy.Value, filter.SortOrder.Value) }
							</a>
						</th>
						<th>
							<a href={ "/fuels?sort=supplier&order=" + GetSortOrder("supplier", filter.SortBy.Value, filter.SortOrder.Value) }>
								Supplier { GetSortIcon("supplier", filter.SortBy.Value, filter.SortOrder.Value) }
							</a>
						</th>
						<th>
							<a href={ "/fuels?sort=price&order=" + GetSortOrder("price", filter.SortBy.Value, filter.SortOrder.Value) }>
								Price { GetSortIcon("price", filter.SortBy.Value, filter.SortOrder.Value) }
							</a>
						</th>
						<th>
							<a href={ "/fuels?sort=created_at&order=" + GetSortOrder("created_at", filter.SortBy.Value, filter.SortOrder.Value) }>
								Created { GetSortIcon("created_at", filter.SortBy.Value, filter.SortOrder.Value) }
							</a>
						</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					if len(fuels) == 0 {
						<tr>
							<td colspan="7" class="has-text-centered py-6">
								<div class="content">
									<span class="icon is-large has-text-grey-light">
										<i class="fas fa-gas-pump fa-2x"></i>
									</span>
									<p class="mt-3 has-text-grey">No fuel types found</p>
								</div>
							</td>
						</tr>
					} else {
						for _, fuel := range fuels {
							<tr>
								<td><input type="checkbox" name="selected_ids" value={ fmt.Sprintf("%d", fuel.FuelID) } class="fuel-checkbox"/></td>
								<td>
									<span class="tag is-light is-family-monospace">{ fuel.FuelID }</span>
								</td>
								<td>
									<span class="has-text-weight-medium">{ fuel.Name }</span>
								</td>
								<td>
									if fuel.Supplier != nil && *fuel.Supplier != "" {
										<span>{ *fuel.Supplier }</span>
									} else {
										<span class="has-text-grey-light">—</span>
									}
								</td>
								<td>
									<span class="tag is-info is-light">${ fuel.Price }</span>
								</td>
								<td>
									<time datetime={ fuel.CreatedAt.Format(time.RFC3339) } title={ fuel.CreatedAt.Format("Jan 2, 2006 15:04:05") }>
										{ fuel.CreatedAt.Format("2006-01-02") }
									</time>
								</td>
								<td>
									<div class="buttons are-small is-justify-content-end">
										<button
											class="button is-info is-outlined"
											title="Edit fuel type"
											hx-get={ fmt.Sprintf("/fuels/%d/edit", fuel.FuelID) }
											hx-push-url="true"
											hx-target="#modal-container"
											hx-swap="innerHTML"
										>
											<span class="icon">
												<i class="fas fa-edit"></i>
											</span>
										</button>
										<button
											class="button is-danger is-outlined"
											title="Delete fuel type"
											hx-delete={ fmt.Sprintf("/fuels/%d", fuel.FuelID) }
											hx-target="closest tr"
											hx-swap="outerHTML swap:1s"
											hx-confirm="Are you sure you want to delete this fuel type?"
										>
											<span class="icon">
												<i class="fas fa-trash"></i>
											</span>
										</button>
										<a
											class="button is-link is-outlined"
											title="View details"
											href={ fmt.Sprintf("/fuels/%d", fuel.FuelID) }
										>
											<span class="icon">
												<i class="fas fa-eye"></i>
											</span>
										</a>
									</div>
								</td>
							</tr>
						}
					}
				</tbody>
			</table>
		</div>
		if totalCount > 0 {
			@Pagination("/fuels", totalCount, limit, offset, filter)
		}
	</div>
}

templ FuelRow(fuel models.Fuel) {
	<tr>
		<td>
			<span class="tag is-light is-family-monospace">{ fuel.FuelID }</span>
		</td>
		<td>
			<span class="has-text-weight-medium">{ fuel.Name }</span>
		</td>
		<td>
			if fuel.Supplier != nil && *fuel.Supplier != "" {
				<span>{ *fuel.Supplier }</span>
			} else {
				<span class="has-text-grey-light">—</span>
			}
		</td>
		<td>
			<span class="tag is-info is-light">${ fuel.Price }</span>
		</td>
		<td>
			<time datetime={ fuel.CreatedAt.Format(time.RFC3339) } title={ fuel.CreatedAt.Format("Jan 2, 2006 15:04:05") }>
				{ fuel.CreatedAt.Format("2006-01-02") }
			</time>
		</td>
		<td>
			<div class="buttons are-small is-justify-content-end">
				<button
					class="button is-info is-outlined"
					title="Edit fuel type"
					hx-get={ fmt.Sprintf("/fuels/%d/edit", fuel.FuelID) }
					hx-push-url="true"
					hx-target="#modal-container"
					hx-swap="innerHTML"
				>
					<span class="icon">
						<i class="fas fa-edit"></i>
					</span>
				</button>
				<button
					class="button is-danger is-outlined"
					title="Delete fuel type"
					hx-delete={ fmt.Sprintf("/fuels/%d", fuel.FuelID) }
					hx-target="closest tr"
					hx-swap="outerHTML swap:1s"
					hx-confirm="Are you sure you want to delete this fuel type?"
				>
					<span class="icon">
						<i class="fas fa-trash"></i>
					</span>
				</button>
				<a
					class="button is-link is-outlined"
					title="View details"
					href={ fmt.Sprintf("/fuels/%d", fuel.FuelID) }
				>
					<span class="icon">
						<i class="fas fa-eye"></i>
					</span>
				</a>
			</div>
		</td>
	</tr>
}

templ FuelDetail(fuel models.Fuel) {
	<div class="box">
		<div class="level">
			<div class="level-left">
				<div class="level-item">
					<div>
						<h1 class="title">{ fuel.Name }</h1>
						<h2 class="subtitle">Fuel Type #{ fuel.FuelID }</h2>
					</div>
				</div>
			</div>
			<div class="level-right">
				<div class="level-item">
					<div class="buttons">
						<a class="button is-info" href={ fmt.Sprintf("/fuels/%d/edit", fuel.FuelID) }>
							<span class="icon"><i class="fas fa-edit"></i></span>
							<span>Edit</span>
						</a>
						<button
							class="button is-danger"
							hx-delete={ fmt.Sprintf("/fuels/%d", fuel.FuelID) }
							hx-confirm="Are you sure you want to delete this fuel type?"
							hx-redirect="/fuels"
						>
							<span class="icon"><i class="fas fa-trash"></i></span>
							<span>Delete</span>
						</button>
					</div>
				</div>
			</div>
		</div>
		<div class="content">
			<div class="columns">
				<div class="column">
					<h3 class="title is-5">Fuel Information</h3>
					<table class="table is-striped">
						<tbody>
							<tr>
								<th>Name</th>
								<td>{ fuel.Name }</td>
							</tr>
							<tr>
								<th>Supplier</th>
								<td>
									if fuel.Supplier != nil && *fuel.Supplier != "" {
										<span>{ *fuel.Supplier }</span>
									} else {
										<span class="has-text-grey-light">Not specified</span>
									}
								</td>
							</tr>
							<tr>
								<th>Price per Liter</th>
								<td>
									<span class="tag is-info is-large">${ fuel.Price }</span>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="column">
					<h3 class="title is-5">Timestamps</h3>
					<table class="table is-striped">
						<tbody>
							<tr>
								<th>Created</th>
								<td>{ fuel.CreatedAt.Format("2006-01-02 15:04:05") }</td>
							</tr>
							<tr>
								<th>Updated</th>
								<td>{ fuel.UpdatedAt.Format("2006-01-02 15:04:05") }</td>
							</tr>
							if !fuel.DeletedAt.IsZero() {
								<tr>
									<th>Deleted</th>
									<td class="has-text-danger">{ fuel.DeletedAt.Format("2006-01-02 15:04:05") }</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
}

templ FuelEditForm(fuel models.Fuel, errors map[string]string) {
	<form hx-put={ fmt.Sprintf("/fuels/%d", fuel.FuelID) } hx-target="#main-content">
		<div class="field">
			<label class="label">Name</label>
			<div class="control">
				<input class={ fmt.Sprintf("input %s", GetErrorClass(errors, "name")) } type="text" name="name" value={ fuel.Name } required/>
			</div>
			if err, ok := errors["name"]; ok {
				<p class="help is-danger">{ err }</p>
			}
		</div>
		<div class="field">
			<label class="label">Supplier</label>
			<div class="control">
				if fuel.Supplier != nil {
					<input
						class={ fmt.Sprintf("input %s", GetErrorClass(errors, "supplier")) }
						type="text"
						name="supplier"
						value={ *fuel.Supplier }
					/>
				} else {
					<input class={ fmt.Sprintf("input %s", GetErrorClass(errors, "supplier")) } type="text" name="supplier"/>
				}
			</div>
			if err, ok := errors["supplier"]; ok {
				<p class="help is-danger">{ err }</p>
			}
		</div>
		<div class="field">
			<label class="label">Price per Liter</label>
			<div class="control">
				<input class={ fmt.Sprintf("input %s", GetErrorClass(errors, "cost")) } type="text" name="cost" value={ fuel.Price } required/>
			</div>
			if err, ok := errors["cost"]; ok {
				<p class="help is-danger">{ err }</p>
			} else {
				<p class="help">Format: 0.00 (e.g., 1.45)</p>
			}
		</div>
		<div class="field is-grouped">
			<div class="control">
				<button type="submit" class="button is-primary">Save Changes</button>
			</div>
			<div class="control">
				<button type="button" class="button is-light" onclick="closeModal()">Cancel</button>
			</div>
		</div>
	</form>
}

templ FuelCreateForm(errors map[string]string) {
	<form hx-post="/fuels" hx-target="#main-content">
		<div class="field">
			<label class="label">Name</label>
			<div class="control">
				<input class={ fmt.Sprintf("input %s", GetErrorClass(errors, "name")) } type="text" name="name" placeholder="Enter fuel type name" required/>
			</div>
			if err, ok := errors["name"]; ok {
				<p class="help is-danger">{ err }</p>
			}
		</div>
		<div class="field">
			<label class="label">Supplier</label>
			<div class="control">
				<input class={ fmt.Sprintf("input %s", GetErrorClass(errors, "supplier")) } type="text" name="supplier" placeholder="Enter supplier name (optional)"/>
			</div>
			if err, ok := errors["supplier"]; ok {
				<p class="help is-danger">{ err }</p>
			}
		</div>
		<div class="field">
			<label class="label">Price per Liter</label>
			<div class="control">
				<input class={ fmt.Sprintf("input %s", GetErrorClass(errors, "cost")) } type="text" name="cost" placeholder="0.00" required/>
			</div>
			if err, ok := errors["cost"]; ok {
				<p class="help is-danger">{ err }</p>
			} else {
				<p class="help">Format: 0.00 (e.g., 1.45)</p>
			}
		</div>
		<div class="field is-grouped">
			<div class="control">
				<button type="submit" class="button is-primary">Create Fuel Type</button>
			</div>
			<div class="control">
				<button type="button" class="button is-light" onclick="closeModal()">Cancel</button>
			</div>
		</div>
	</form>
}
